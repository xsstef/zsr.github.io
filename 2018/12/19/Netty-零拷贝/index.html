<!doctype html><html class="theme-next pisces use-motion"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css"><meta name="keywords" content="Netty,"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1"><meta name="description" content="1Zero-Copy describes computer operations in which the CPU does not perform the task of copying data from one memory area to another.
磁盘数据通过网络发送步骤
当应用程序发起read系统调用时，通过DMA（Direct Memory Access）将数据copy到内核"><meta property="og:type" content="article"><meta property="og:title" content="Netty 零拷贝"><meta property="og:url" content="http://zsr.github.io/2018/12/19/Netty-零拷贝/index.html"><meta property="og:site_name" content="Hello Coder"><meta property="og:description" content="1Zero-Copy describes computer operations in which the CPU does not perform the task of copying data from one memory area to another.
磁盘数据通过网络发送步骤
当应用程序发起read系统调用时，通过DMA（Direct Memory Access）将数据copy到内核"><meta property="og:image" content="https://ws2.sinaimg.cn/large/006tNbRwgy1fymbp5iat5j30uo0imjsz.jpg"><meta property="og:image" content="https://ws3.sinaimg.cn/large/006tNbRwgy1fynh0n2p3wj30l40bwmxi.jpg"><meta property="og:updated_time" content="2019-02-12T06:48:13.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Netty 零拷贝"><meta name="twitter:description" content="1Zero-Copy describes computer operations in which the CPU does not perform the task of copying data from one memory area to another.
磁盘数据通过网络发送步骤
当应用程序发起read系统调用时，通过DMA（Direct Memory Access）将数据copy到内核"><meta name="twitter:image" content="https://ws2.sinaimg.cn/large/006tNbRwgy1fymbp5iat5j30uo0imjsz.jpg"><script type="text/javascript" id="hexo.configuration">var NexT=window.NexT||{},CONFIG={scheme:"Pisces",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:0,author:"博主"}}</script><link rel="canonical" href="http://zsr.github.io/2018/12/19/Netty-零拷贝/"><title> Netty 零拷贝 | Hello Coder</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-81477846-1","auto"),ga("send","pageview")</script><div class="container one-collumn sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Hello Coder</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div> <span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> Netty 零拷贝</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2018-12-19T21:00:32+08:00" content="2018-12-19">2018-12-19</time></span></div></header><div class="post-body" itemprop="articleBody"><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Zero-Copy describes computer operations in which the CPU does not perform the task of copying data from one memory area to another.</div></pre></td></tr></table></figure><h3 id="磁盘数据通过网络发送"><a href="#磁盘数据通过网络发送" class="headerlink" title="磁盘数据通过网络发送"></a>磁盘数据通过网络发送</h3><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><ol><li>当应用程序发起<code>read</code>系统调用时，通过<code>DMA（Direct Memory Access）</code>将数据<code>copy</code>到内核空间<code>buffer</code></li><li>然后由<code>CPU</code>控制将内核空间数据<code>copy</code>到用户空间下的 <code>buffer</code>中</li><li><code>read</code>调用完成后，<code>write</code>调用首先将用户空间下 <code>buffer</code>中的数据<code>copy</code>到内核模式下的<code>socket buffer</code>中</li><li>最后通过<code>DMA</code>将内核模式下的<code>socket buffer</code>中的数据<code>copy</code>到网卡<code>buffer</code>中</li></ol><h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p>数据从内核模式到用户模式走了一圈，浪费了两次<code>copy</code>，而这两次<code>copy</code>都是<code>CPU copy</code>(占用<code>CPU</code>资源)</p><h3 id="操作系统-零拷贝"><a href="#操作系统-零拷贝" class="headerlink" title="操作系统 零拷贝"></a>操作系统 零拷贝</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">OS-level zero copy involves avoiding copying memory blocks from one location to another (typically from user space to kernel space) before sending data to the hardware driver (network card or disk drive) or vice versa.</div></pre></td></tr></table></figure><p>典型场景：内核空间和用户空间的数据拷贝</p><h4 id="Linux-sendfile"><a href="#Linux-sendfile" class="headerlink" title="Linux sendfile"></a><code>Linux sendfile</code></h4><p><strong>os &gt;= Linux 2.4内核</strong></p><h5 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h5><ol><li><code>DMA copy</code>将磁盘数据<code>copy</code>到<code>kernel buffer</code>中</li><li>向<code>socket buffer</code>中追加当前要发送的数据在<code>kernel buffer</code>中的位置和偏移量</li><li><code>DMA gather copy</code>（需要网卡支持数据收集模式）根据<code>socket buffer</code>中的位置和偏移量直接将<code>kernel buffer</code>中的数据<code>copy</code>到网卡上</li></ol><h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><p>程序只需发出一次系统调用<code>sendfile()</code>，数据只经过了2次<code>copy</code>就从磁盘传送出去了，没有<code>CPU copy</code></p><p><code>nginx</code>，<code>java FileChannel.transferTo()</code>等在<code>Linux</code>系统中都引用了<code>sendfile</code>机制</p><h3 id="FileChannel-transferTo-Java中的零拷贝"><a href="#FileChannel-transferTo-Java中的零拷贝" class="headerlink" title="FileChannel.transferTo(Java中的零拷贝)"></a><code>FileChannel.transferTo</code>(<code>Java中的零拷贝</code>)</h3><p><code>Java NIO</code>中<code>FileChannel.transferTo(long position, long count, WriteableByteChannel target)</code>方法将当前通道中的数据传送到目标通道中，在支持<code>Zero-Copy</code>的<code>linux</code>系统中，<code>transferTo()</code>的实现依赖于<code>sendfile()</code>调用</p><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fymbp5iat5j30uo0imjsz.jpg" alt=""></p><h3 id="Netty零拷贝"><a href="#Netty零拷贝" class="headerlink" title="Netty零拷贝"></a><code>Netty</code>零拷贝</h3><ol><li><code>Netty</code>的接收和发送<code>ByteBuffer</code>采用<code>DIRECT BUFFERS</code>，使用堆外内存进行<code>Socket</code>读写，不需要进行字节缓冲区的二次拷贝。如果使用传统的堆内存（<code>HEAP BUFFERS</code>）进行<code>Socket</code>读写，<code>JVM</code>会将堆内存<code>Buffer</code>拷贝一份到直接内存中，然后才写入<code>Socket</code>中。相比于堆外直接内存，消息在发送过程中多了一次缓冲区的内存拷贝。</li><li><p><code>Netty</code>提供了<code>CompositeByteBuf</code>对象，可以聚合多个<code>ByteBuffer</code>对象，用户可以像操作一个<code>Buffer</code>那样方便的对组合<code>Buffer</code>进行操作，避免了传统通过内存拷贝的方式将几个小<code>Buffer</code>合并成一个大的<code>Buffer</code>。</p></li><li><p><code>Netty</code>的文件传输采用了<code>java nio transferTo</code>方法，它可以直接将文件缓冲区的数据发送到目标<code>Channel</code>（传统的做法: 拷贝文件内容到临时 <code>buffer</code>, 然后再将 <code>buffer</code> 写入<code>Channel</code>），使用操作系统级别的零拷贝，避免了传统通过循环<code>write</code>方式导致的内存拷贝问题</p></li></ol><h4 id="CompositeByteBuf"><a href="#CompositeByteBuf" class="headerlink" title="CompositeByteBuf"></a><code>CompositeByteBuf</code></h4><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fynh0n2p3wj30l40bwmxi.jpg" alt=""></p><p><strong>注意： <code>CompositeByteBuf</code> 是由多个 <code>ByteBuf</code> 组合而成的, 不过在 <code>CompositeByteBuf</code> 内部, 这些 <code>ByteBuf</code> 都是单独存在的, <code>CompositeByteBuf</code> 保存了它们的引用，只是在逻辑上是一个整体</strong></p><h4 id="java-ByteBuffer-vs-netty-ByteBuf"><a href="#java-ByteBuffer-vs-netty-ByteBuf" class="headerlink" title="java ByteBuffer vs netty ByteBuf"></a><code>java ByteBuffer</code> vs <code>netty ByteBuf</code></h4><p><code>java</code> 本身就有 <code>ByteBuffer</code>，为什么要额外设计一个 <code>ByteBuf</code>?</p><ul><li><code>ByteBuffer</code> 只用一个 <code>position</code> 变量表示当前位置，所以在进行读写切换的时候都需要调用<code>flip()</code>和<code>clear()</code>等方法，否则功能将出错</li><li><code>ByteBuf</code> 使用 <code>readerIndex</code> 和 <code>writerIndex</code> 分别表示读写位置，不需要调用函数切换，体验更好。</li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://segmentfault.com/a/1190000007692223" target="_blank" rel="external">磁盘及网络IO工作方式解析</a></p><p><a href="https://stackoverflow.com/questions/20727615/is-nettys-zero-copy-different-from-os-level-zero-copy" target="_blank" rel="external">Is Netty’s Zero Copy different from OS level Zero Copy?</a></p><p><a href="https://caorong.github.io/2017/01/16/head-first-netty-3/" target="_blank" rel="external">深入浅出Netty - ByteBuf 和 ByteBufPool</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/Netty/" rel="tag">#Netty</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/12/15/Netty-核心组件/" rel="next" title="Netty 核心组件"><i class="fa fa-chevron-left"></i> Netty 核心组件</a></div><div class="post-nav-prev post-nav-item"></div></div></footer></article><div class="post-spread"><div class="jiathis_style"><a class="jiathis_button_tsina"></a><a class="jiathis_button_tqq"></a><a class="jiathis_button_weixin"></a><a class="jiathis_button_cqq"></a><a class="jiathis_button_douban"></a><a class="jiathis_button_renren"></a><a class="jiathis_button_qzone"></a><a class="jiathis_button_kaixin001"></a><a class="jiathis_button_copy"></a><a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script></div></div></div><p>热评文章</p><div class="ds-top-threads" data-range="weekly" data-num-items="4"></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="David"><p class="site-author-name" itemprop="name">David</p><p class="site-description motion-element" itemprop="description">Develop Notes</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">152</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags"><span class="site-state-item-count">37</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/zsr" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/u/2214956781" target="_blank" title="Weibo"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#磁盘数据通过网络发送"><span class="nav-number">1.</span> <span class="nav-text">磁盘数据通过网络发送</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#步骤"><span class="nav-number">1.1.</span> <span class="nav-text">步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#缺点"><span class="nav-number">1.2.</span> <span class="nav-text">缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#操作系统-零拷贝"><span class="nav-number">2.</span> <span class="nav-text">操作系统 零拷贝</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Linux-sendfile"><span class="nav-number">2.1.</span> <span class="nav-text">Linux sendfile</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#步骤-1"><span class="nav-number">2.1.1.</span> <span class="nav-text">步骤</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#优点"><span class="nav-number">2.1.2.</span> <span class="nav-text">优点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FileChannel-transferTo-Java中的零拷贝"><span class="nav-number">3.</span> <span class="nav-text">FileChannel.transferTo(Java中的零拷贝)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Netty零拷贝"><span class="nav-number">4.</span> <span class="nav-text">Netty零拷贝</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CompositeByteBuf"><span class="nav-number">4.1.</span> <span class="nav-text">CompositeByteBuf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#java-ByteBuffer-vs-netty-ByteBuf"><span class="nav-number">4.2.</span> <span class="nav-text">java ByteBuffer vs netty ByteBuf</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2019</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">David</span></div><div class="powered-by"> 由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="theme-info"> 主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),s=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!0,s=r.title.trim().toLowerCase(),n=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),i=r.url,o=-1,l=-1,p=-1;if(""!=s&&""!=n&&a.forEach(function(e,t){o=s.indexOf(e),l=n.indexOf(e),o<0&&l<0?c=!1:(l<0&&(l=0),0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+i+"' class='search-result-title'>"+s+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;u<0&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),s.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script></body></html>