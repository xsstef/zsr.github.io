<!doctype html><html class="theme-next pisces use-motion"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css"><meta name="keywords" content="Hexo, NexT"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1"><meta name="description" content="Develop Notes"><meta property="og:type" content="website"><meta property="og:title" content="Hello Coder"><meta property="og:url" content="http://zsr.github.io/index.html"><meta property="og:site_name" content="Hello Coder"><meta property="og:description" content="Develop Notes"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Hello Coder"><meta name="twitter:description" content="Develop Notes"><script type="text/javascript" id="hexo.configuration">var NexT=window.NexT||{},CONFIG={scheme:"Pisces",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:0,author:"博主"}}</script><link rel="canonical" href="http://zsr.github.io/"><title> Hello Coder</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-81477846-1","auto"),ga("send","pageview")</script><div class="container one-collumn sidebar-position-left page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Hello Coder</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div> <span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/12/15/Netty-核心组件/" itemprop="url">Netty 核心组件</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2018-12-15T18:47:35+08:00" content="2018-12-15">2018-12-15</time></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="Netty工作架构图"><a href="#Netty工作架构图" class="headerlink" title="Netty工作架构图"></a><code>Netty</code>工作架构图</h3><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fy8w6dygu9j30fa0cs0t5.jpg" alt=""></p><h3 id="模块组件"><a href="#模块组件" class="headerlink" title="模块组件"></a>模块组件</h3><h4 id="Bootstrap"><a href="#Bootstrap" class="headerlink" title="Bootstrap"></a><code>Bootstrap</code></h4><p><code>Bootstrap</code>是启动引导类，一个 <code>Netty</code> 应用通常由一个 <code>Bootstrap</code> 开始，主要作用是配置整个 <code>Netty</code> 程序，串联各个组件</p><ul><li><code>Bootstrap</code> 类是客户端程序的启动引导类</li><li><code>ServerBootstrap</code> 类是服务端启动引导类</li></ul><h4 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a><code>Channel</code></h4><p><code>Channel</code>的本质是对操作系统产生的FD（文件描述符）的映射，并且提供绑定到<code>Selector</code>多路选择器上的能力</p><h4 id="ChannelFuture"><a href="#ChannelFuture" class="headerlink" title="ChannelFuture"></a><code>ChannelFuture</code></h4><p>在 <code>Netty</code> 中所有的IO操作都是异步的，不能立刻得知消息是否被正确处理。 <code>Future</code> 对象可以看作是一个异步操作结果的占位符；它将在未来的某个时刻完成，并提供对其结果的访问。</p><p><code>Netty</code> 提供了<code>ChannelFuture</code>，用于在执行异步操作的时候使用。每个<code>Netty</code>的出站IO操作都会返回一个<code>ChannelFuture</code>。<code>ChannelFuture</code>可以注册<code>ChannelFutureListener</code> 实例，其中的回调方法<code>operationComplete()</code>,将会在对应的操作完成时被调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">ChannelFuture <span class="title">write</span><span class="params">(Object msg, ChannelPromise promise)</span></span>;</div></pre></td></tr></table></figure><h4 id="ChannelHandler"><a href="#ChannelHandler" class="headerlink" title="ChannelHandler"></a><code>ChannelHandler</code></h4><p><code>ChannelHandler</code> 是一个接口，它充当了所有处理入站和出站数据的应用程序逻辑的容器，并将其转发到其 <code>ChannelPipeline</code>中的下一个<code>ChannelHandler</code>；该类是基于事件驱动的，它会响应相关的事件然后去调用其关联的回调函数，例如：当一个新的连接被建立时，<code>ChannelHandler</code>的<code>channelActive()</code>方法将会被调用</p><p><code>ChannelHandler</code>子类，例如：</p><ul><li><code>ChannelInboundHandler</code>：用于处理入站IO事件。</li><li><code>ChannelOutboundHandler</code>：用于处理出站IO操作。</li></ul><h4 id="ChannelPipline"><a href="#ChannelPipline" class="headerlink" title="ChannelPipline"></a><code>ChannelPipline</code></h4><p><code>ChannelPipeline</code> 是聚合了 <code>ChannelHandler</code> 的管道，本质上是一个职责链路（用于处理<code>Channel</code>的入站事件和出站操作），在<code>Worker</code>线程中会对每一个<code>Channel</code>执行其所对应的<code>pipeline</code>链，完成整个生命周期。</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fy8rq2caj7j30uw08k76d.jpg" alt=""></p><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fy8tkgaop2j31jo0mcac9.jpg" alt=""></p><p>蓝色表示 <code>ChannelInboundHandler</code> ，绿色表示 <code>ChannelOutboundHandler</code>，黄色则承担两个角色，而每个<code>Handler</code>又会使用 <code>ChannelHandlerContext</code> 封装起来，在 <code>ChannelPipeline</code> 中组装成双向链表。</p><p><strong>ChannelPipeline handler 执行顺序</strong>：</p><ul><li><strong>入站事件流从头到尾执行所有的<code>handler</code>(入站的时候也会经过<code>OutboundChannelHandler</code>，只不过略过了这个<code>ChannelHandler</code>)</strong></li><li><strong>出站事件流从尾到头执行所有的<code>handler</code>(出站的时候也会经过<code>InboundChannelHandler</code>，只不过略过了这个<code>ChannelHandler</code>)</strong></li></ul><p><strong>注意： 在具体业务处理类<code>ProcessingHandler</code>中将响应数据发出有2种方式</strong>：</p><ol><li><code>ChannelHandlerContext.writeAndFlush(msg)</code>：不用经过<code>TailConext</code>, 从该<code>handler</code>开始往前执行<code>OutboundChannelHandler</code>，性能更好一些</li><li><code>ChannelHandlerContext.pipeline().writeAndFlush(msg)</code>：从<code>TailConext</code>开始执行， 往前执行<code>OutboundChannelHandler</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> AbstractChannelHandlerContext <span class="title">findContextOutbound</span><span class="params">()</span> </span>&#123;</div><div class="line">        AbstractChannelHandlerContext ctx = <span class="keyword">this</span>;</div><div class="line">        do &#123;</div><div class="line">            <span class="comment">// 注意，这里是往前找</span></div><div class="line">            ctx = ctx.prev;</div><div class="line">        &#125; <span class="keyword">while</span> (!ctx.outbound);</div><div class="line">        <span class="keyword">return</span> ctx;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><h4 id="EventLoop"><a href="#EventLoop" class="headerlink" title="EventLoop"></a><code>EventLoop</code></h4><p><code>EventLoop</code> 是事件循环，对应<code>Reactor</code>线程，以 <code>NioEventLoop</code> 为例，实现原理是：维护了一个线程和任务队列，支持异步提交任务，线程启动时会调用<code>NioEventLoop</code> 的 <code>run</code> 方法，执行IO任务和非IO任务，由于 <code>EventLoop</code> 是单线程，因此在使用时要注意耗时操作，阻塞操作都不要放到 <code>EventLoop</code> 中，其适合处理耗时短并且简单的任务</p><ul><li><strong>IO任务</strong>：即 <code>selectionKey</code> 中事件，如 <code>accept</code>、<code>connect</code>、<code>read</code>、<code>write</code>等，由<code>processSelectedKeys</code>方法触发。</li><li><strong>非IO任务</strong>：添加到 <code>taskQueue</code> 中的任务，如延迟任务，由 <code>runAllTasks</code> 方法触发。</li></ul><p>两种任务的执行时间比由变量 <code>ioRatio</code> 控制，默认为50%，则表示允许<strong>非IO任务执行的时间与IO任务的执行时间相等</strong></p><h4 id="EventLoopGroup"><a href="#EventLoopGroup" class="headerlink" title="EventLoopGroup"></a><code>EventLoopGroup</code></h4><p><code>EventLoopGroup</code>包含一个或者多个<code>EventLoop</code>，主要管理<code>EventLoop</code>的生命周期，可以理解为一个线程池，内部维护了一组线程，<strong>每个线程(<code>EventLoop</code>)可以负责处理多个<code>Channel</code>上的事件，而一个<code>Channel</code>只能注册于一个<code>EventLoop</code>(防止线程并发问题)</strong></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.lmlphp.com/user/95/article/item/12624/" target="_blank" rel="external">最透彻的Netty原理架构解析</a></p><p><a href="http://www.liuhaihua.cn/archives/530938.html" target="_blank" rel="external">Netty–Reactor模型的应用</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/12/15/Netty-fix-epoll-bug/" itemprop="url">Netty fix epoll bug</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2018-12-15T11:52:13+08:00" content="2018-12-15">2018-12-15</time></span></div></header><div class="post-body" itemprop="articleBody"><p><code>JDK NIO</code>的<code>epoll bug</code>，会导致<code>Selector</code>空轮询，最终导致CPU 100%</p><h3 id="Bug出现的原因"><a href="#Bug出现的原因" class="headerlink" title="Bug出现的原因"></a><strong><code>Bug</code>出现的原因</strong></h3><p>若<code>Selector</code>的轮询结果一直为空，没有新消息处理，则发生空轮询，CPU使用率100%（在<code>selector</code>中，即使是<code>select</code>轮询事件为0的话，照样不断的从<code>select</code>本应该阻塞状态下<code>wake up</code>出来）</p><h3 id="Netty的解决方案"><a href="#Netty的解决方案" class="headerlink" title="Netty的解决方案"></a><strong><code>Netty</code>的解决方案</strong></h3><ul><li>对<code>Selector</code>的<code>select</code>操作周期进行统计，每完成一次空的<code>select</code>操作进行一次计数</li><li>若在某个周期内连续发生N次空轮询，则触发了<code>epoll</code>死循环bug。</li><li>重建<code>Selector</code>，将出现bug的<code>Selector</code>上的<code>channel</code>重新注册到新的<code>Selector</code>上，并将原来的<code>Selector</code>关闭，使用新的<code>Selector</code>进行替换。</li></ul><h3 id="JDK源码分析："><a href="#JDK源码分析：" class="headerlink" title="JDK源码分析："></a><code>JDK</code>源码分析：</h3><p><code>JDK NIO</code>执行代码如下：</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy7ija4ukgj311e0j2q7v.jpg" alt=""></p><p>执行<code>selector.select()</code>方法返回keys是0，所以本应该对key值进行遍历的事件处理根本没有执行，又回到最上面的<code>while(true)</code>循环，循环往复，不断的轮询，直到系统出现100%的CPU情况，最终导致程序崩溃。</p><h3 id="Netty源码分析"><a href="#Netty源码分析" class="headerlink" title="Netty源码分析"></a><code>Netty</code>源码分析</h3><p>具体位置在实现类<code>NioEventLoop</code>中：</p><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fy7jey5qmkj315c0nigso.jpg" alt=""></p><p><code>netty</code>会在每次进行 <code>selector.select(timeoutMillis)</code> 之前记录一下开始时间<code>currentTimeNanos</code>，在<code>select</code>之后记录一下结束时间，判断<code>select</code>操作是否至少持续了<code>timeoutMillis</code>时间；<code>selectCnt</code>记录空轮询次数</p><h4 id="重建selector"><a href="#重建selector" class="headerlink" title="重建selector"></a>重建<code>selector</code></h4><p>当发生<code>epoll bug</code>，则创建一个新的<code>Selector</code>，将出现bug的<code>Selector</code>上的<code>channel</code>重新注册到新的<code>Selector</code>上，关闭bug的<code>Selector</code>，使用新的<code>Selector</code>进行替换 :</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy7k5ilf63j31h40u0ahl.jpg" alt=""></p><p><code>Netty</code>的解决策略：</p><ul><li>根据该<code>bug</code>的特征，首先侦测该<code>bug</code>是否发生</li><li>将问题<code>Selector</code>上注册的<code>Channel</code>转移到新建的<code>Selector</code>上</li><li>老的问题<code>Selector</code>关闭，使用新建的<code>Selector</code>替换</li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.cnblogs.com/JAYIT/p/8241634.html" target="_blank" rel="external">NIO的epoll空轮询bug</a></p><p><a href="http://blogxin.cn/2017/03/20/Netty-epollbug/" target="_blank" rel="external">Netty源码分析 解决NIO的epoll死循环bug</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/12/14/java-和netty-epoll实现/" itemprop="url">java 和netty epoll实现</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2018-12-14T18:03:02+08:00" content="2018-12-14">2018-12-14</time></span></div></header><div class="post-body" itemprop="articleBody"><p><code>Java NIO</code>根据操作系统不同， 针对<code>Selector</code>有不同的默认实现：</p><ul><li><strong>macosx</strong>：KQueueSelectorProvider</li><li><strong>solaris</strong>：DevPollSelectorProvider</li><li><strong>Linux</strong>：EPollSelectorProvider (Linux kernels &gt;= 2.6)或 PollSelectorProvider</li><li><strong>windows</strong>： WindowsSelectorProvider</li></ul><h3 id="为什么netty还要提供一个基于epoll的实现"><a href="#为什么netty还要提供一个基于epoll的实现" class="headerlink" title="为什么netty还要提供一个基于epoll的实现"></a>为什么<code>netty</code>还要提供一个基于<code>epoll</code>的实现</h3><p>自4.0.16起, <code>Netty</code>为<code>Linux</code>通过<code>JNI</code>的方式提供了<code>native socket transport</code>.</p><ul><li><code>NioEventLoopGroup</code> → <code>EpollEventLoopGroup</code></li><li><code>NioEventLoop</code> → <code>EpollEventLoop</code></li><li><code>NioServerSocketChannel</code> → <code>EpollServerSocketChannel</code></li><li><code>NioSocketChannel</code> → <code>EpollSocketChannel</code></li></ul><p><strong>原因：</strong></p><ol><li><code>Netty</code>的 <code>epoll transport</code>使用 <code>epoll</code>边缘触发 而 <code>java nio</code> 使用 <code>epoll</code>水平触发（在这个模式下，io来了数据，就只通知这些io设备对应的fd，上次通知过的fd不再通知，内核不用扫描一大堆fd）</li><li><code>netty epoll transport</code> 暴露了更多的<code>java nio</code>没有的配置参数， 如 <code>TCP_CORK</code>, <code>SO_REUSEADDR</code>等</li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://netty.io/wiki/native-transports.html" target="_blank" rel="external">Netty native transports</a></p><p><a href="https://stackoverflow.com/questions/23465401/why-native-epoll-support-is-introduced-in-netty" target="_blank" rel="external">Why native epoll support is introduced in Netty?</a></p><p><a href="https://www.cnblogs.com/tianhangzhang/p/5374034.html" target="_blank" rel="external">高性能网络服务器编程：为什么linux下epoll是最好，Netty要比NIO好？</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/12/14/Netty-Server-Demo/" itemprop="url">Netty Server Demo</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2018-12-14T17:15:39+08:00" content="2018-12-14">2018-12-14</time></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="Maven添加依赖"><a href="#Maven添加依赖" class="headerlink" title="Maven添加依赖"></a><code>Maven</code>添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.29.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><h3 id="Server-Demo"><a href="#Server-Demo" class="headerlink" title="Server Demo"></a><code>Server Demo</code></h3><h4 id="模拟请求-响应model"><a href="#模拟请求-响应model" class="headerlink" title="模拟请求/响应model"></a>模拟请求/响应<code>model</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.netty;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestData</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> intValue;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIntValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> intValue;</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIntValue</span><span class="params">(<span class="keyword">int</span> intValue)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.intValue = intValue;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// return RequestData inValue * 2</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseData</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> intValue;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIntValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> intValue;</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIntValue</span><span class="params">(<span class="keyword">int</span> intValue)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.intValue = intValue;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="服务端对请求解码"><a href="#服务端对请求解码" class="headerlink" title="服务端对请求解码"></a>服务端对请求解码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerRequestDecoder</span> <span class="keyword">extends</span> <span class="title">ReplayingDecoder</span>&lt;<span class="title">RequestData</span>&gt; </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    RequestData data = <span class="keyword">new</span> RequestData();</div><div class="line">    data.setIntValue(in.readInt());</div><div class="line">    out.add(data);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="服务端对响应编码"><a href="#服务端对响应编码" class="headerlink" title="服务端对响应编码"></a>服务端对响应编码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerResponseEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">ResponseData</span>&gt; </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, ResponseData msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    out.writeInt(msg.getIntValue());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="服务端具体业务处理"><a href="#服务端具体业务处理" class="headerlink" title="服务端具体业务处理"></a>服务端具体业务处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerProcessingHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    RequestData requestData = (RequestData) msg;</div><div class="line">    ResponseData responseData = <span class="keyword">new</span> ResponseData();</div><div class="line">    responseData.setIntValue(requestData.getIntValue() * <span class="number">2</span>);</div><div class="line">    ctx.writeAndFlush(responseData);</div><div class="line">    System.out.println(<span class="string">"server receive request: "</span> + requestData.getIntValue());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyTestServer</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">new</span> NettyTestServer(<span class="number">8080</span>).start();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</div><div class="line">    EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</div><div class="line">      bootstrap.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)</div><div class="line">          .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">              ch.pipeline().addLast(<span class="keyword">new</span> ServerRequestDecoder(), <span class="keyword">new</span> ServerResponseEncoder(),</div><div class="line">                  <span class="keyword">new</span> ServerProcessingHandler());</div><div class="line">            &#125;</div><div class="line">          &#125;).option(ChannelOption.SO_BACKLOG, <span class="number">128</span>).childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">      ChannelFuture channelFuture = bootstrap.bind(<span class="keyword">new</span> InetSocketAddress(port)).sync();</div><div class="line">      System.out.println(</div><div class="line">          NettyTestServer.class.getName() + <span class="string">" started and listen on "</span> + channelFuture.channel().localAddress());</div><div class="line"></div><div class="line">      channelFuture.channel().closeFuture().sync();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      workerGroup.shutdownGracefully();</div><div class="line">      bossGroup.shutdownGracefully();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.baeldung.com/netty" target="_blank" rel="external">Introduction to Netty</a></p><p><a href="https://sylvanassun.github.io/2017/11/30/2017-11-30-netty_introduction/" target="_blank" rel="external">Netty的那点事儿</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/12/12/Netty初探/" itemprop="url">Netty初探</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2018-12-12T18:27:22+08:00" content="2018-12-12">2018-12-12</time></span></div></header><div class="post-body" itemprop="articleBody"><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Netty is an asynchronous event-driven network application framework for rapid development of maintainable high performance protocol servers &amp; clients.</div><div class="line"></div><div class="line">Netty is a NIO client server framework which enables quick and easy development of network applications such as protocol servers and clients. It greatly simplifies and streamlines network programming such as TCP and UDP socket server.</div></pre></td></tr></table></figure><h3 id="为什么不选择JAVA原生NIO"><a href="#为什么不选择JAVA原生NIO" class="headerlink" title="为什么不选择JAVA原生NIO"></a>为什么不选择<code>JAVA</code>原生<code>NIO</code></h3><ul><li><code>NIO</code> 的类库和 <code>API</code> 繁杂，使用麻烦：需要熟练掌握 <code>Selector</code>、<code>ServerSocketChannel</code>、<code>SocketChannel</code>、<code>ByteBuffer</code>等。</li><li>编写出高质量的 <code>NIO</code> 程序需要具备其他的额外技能做铺垫：例如熟悉 <code>Java</code> 多线程编程，因为 <code>NIO</code> 编程涉及到 <code>Reactor</code> 模式，必须对多线程和网路编程非常熟悉。</li><li><code>NIO</code> 编程的特点是功能开发相对容易，但是可靠性能力补齐工作量和难度都非常大：例如客户端面临断连重连、网络闪断、半包读写、失败缓存、网络拥塞和异常码流的处理等等。</li><li><a href="http://www.10tiao.com/html/308/201602/401718035/1.html" target="_blank" rel="external"><code>JDK NIO</code>的 <code>Epoll Bug</code>，它会导致<code>Selector</code>空轮询，最终导致<code>CPU 100%</code></a></li></ul><h3 id="为什么选择Netty"><a href="#为什么选择Netty" class="headerlink" title="为什么选择Netty"></a>为什么选择<code>Netty</code></h3><ul><li><code>API</code>使用简单，开发门槛低；</li><li>功能强大，预置了多种编解码功能，支持多种主流协议；</li><li><strong>定制能力强，可以通过ChannelHandler对通信框架进行灵活地扩展；</strong></li><li>性能高，通过与其他业界主流的<code>NIO</code>框架对比，Netty的综合性能最优；</li><li>成熟、稳定，<code>Netty</code>修复了已经发现的所有<code>JDK NIO BUG</code>；</li></ul><h3 id="Netty架构设计"><a href="#Netty架构设计" class="headerlink" title="Netty架构设计"></a><code>Netty</code>架构设计</h3><p><code>Netty</code>采用了比较典型的三层网络架构进行设计，逻辑架构图如下所示：</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy53lm41bjj30ts0fytgt.jpg" alt=""></p><ul><li>传输服务：支持 <code>BIO</code> 和 <code>NIO</code></li><li>容器集成：支持 <code>OSGI</code>、<code>JBossMC</code>、<code>Spring</code>、<code>Guice</code>容器</li><li>协议支持：<code>HTTP</code>、<code>Protobuf</code>、二进制、<code>WebSocket</code>等一系列常见协议都支持。还支持通过实行编码解码逻辑来实现自定义协议</li><li><code>Core</code> 核心：可扩展事件模型、通用通信 <code>API</code>、支持零拷贝的 <code>ByteBuf</code> 缓冲对象</li></ul><h3 id="高性能的三大要素"><a href="#高性能的三大要素" class="headerlink" title="高性能的三大要素"></a><strong>高性能的三大要素</strong></h3><ol><li><strong>传输</strong>：用什么样的通道将数据发送给对方，BIO、NIO 或者 AIO，<strong>IO 模型在很大程度上决定了框架的性能</strong>。</li><li><strong>协议</strong>：采用什么样的通信协议，<code>HTTP</code> 或者内部私有协议。协议的选择不同，性能模型也不同。相比于公有协议，内部私有协议的性能通常可以被设计的更优。</li><li><strong>线程模型</strong>：数据报如何读取？读取之后的编解码在哪个线程进行，编解码后的消息如何派发，<code>Reactor</code> 线程模型的不同，对性能的影响也非常大。</li></ol><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy53swbgjzj30rc0nwdk8.jpg" alt=""></p><h3 id="Netty高性能原因"><a href="#Netty高性能原因" class="headerlink" title="Netty高性能原因"></a><code>Netty</code>高性能原因</h3><h4 id="IO模型"><a href="#IO模型" class="headerlink" title="IO模型"></a><strong>IO模型</strong></h4><p><code>Netty</code>的IO线程<code>NioEventLoop</code>由于聚合了多路复用器<code>Selector</code>，可以同时并发处理成百上千个客户端<code>Channel</code>，由于读写操作都是非阻塞的，这就可以充分提升IO线程的运行效率，避免由于频繁IO阻塞导致的线程挂起</p><h4 id="零拷贝"><a href="#零拷贝" class="headerlink" title="零拷贝"></a>零拷贝</h4><p><strong>在后面的文章专门详解</strong></p><h4 id="内存池"><a href="#内存池" class="headerlink" title="内存池"></a>内存池</h4><p><strong>在后面的文章专门详解</strong></p><h4 id="Netty-线程模型"><a href="#Netty-线程模型" class="headerlink" title="Netty 线程模型"></a><strong>Netty 线程模型</strong></h4><p><code>Netty</code> 主要基于主从 <code>Reactor</code> 多线程模型（如下图）做了一定的修改，其中主从 <code>Reactor</code> 多线程模型有多个 <code>Reactor</code>：</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy548sanm2j30rk0iwh0n.jpg" alt=""></p><ul><li><code>MainReactor</code>负责客户端的连接请求，并将请求转交给 <code>SubReactor</code></li><li><code>SubReactor</code>负责相应通道的IO读写请求</li><li>非IO请求（具体逻辑处理）等待 <code>worker threads</code> 进行处理</li></ul><p><strong>注意：<code>Netty</code> 的线程模型基于主从 <code>Reactor</code>多线程，借用了 <code>MainReactor</code> 和 <code>SubReactor</code> 的结构。但是<code>Netty</code>实际实现上 <code>SubReactor</code> 和 <code>Worker</code> 线程在同一个线程池中</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(); </div><div class="line">EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(); </div><div class="line">ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap(); </div><div class="line">bootstrap.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)</div></pre></td></tr></table></figure><p><code>Netty</code>里对应<code>mainReactor</code>的角色叫做<code>Boss</code>，而对应<code>subReactor</code>的角色叫做<code>Worker</code></p><p><code>bossGroup</code> 和 <code>workerGroup</code> 这两个 <code>group</code> 均是线程池：</p><ul><li><code>bossGroup</code> 线程池则只是在 <code>Bind</code> 某个端口后，获得其中一个线程作为 <code>MainReactor</code>，专门处理端口的 <code>Accept</code> 事件</li><li><code>workerGroup</code> 线程池会被各个<code>SubReactor</code> 和 <code>Worker</code> 线程充分利用</li></ul><h3 id="Netty线程模型"><a href="#Netty线程模型" class="headerlink" title="Netty线程模型"></a>Netty线程模型</h3><p>下图来自组内大牛分享，盗来使用～～：</p><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fy6dbsx3k1j31d60sok1f.jpg" alt=""></p><p><strong>注意：服务器端的 <code>ServerSocketChannel</code> 只绑定到了 <code>bossGroup</code> 中的一个线程, 因此在调用<code>Selector.select</code> 处理客户端的连接请求时, 实际上是在一个线程中的, 所以对只有一个服务(监听一个端口)的应用来说, <code>bossGroup</code> 设置多个线程是没有什么作用的, 反而还会造成资源浪费。</strong></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.baeldung.com/netty" target="_blank" rel="external">Introduction to Netty</a></p><p><a href="https://sylvanassun.github.io/2017/11/30/2017-11-30-netty_introduction/" target="_blank" rel="external">Netty的那点事儿</a></p><p><a href="https://xiaozhuanlan.com/topic/2153098467" target="_blank" rel="external">NIO Reactor 模型 &amp; Netty 线程模型</a></p><p><a href="https://stackoverflow.com/questions/22280916/do-we-need-more-than-a-single-thread-for-boss-group" target="_blank" rel="external">do we need more than a single thread for boss group?</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article></section><nav class="pagination"> <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a></nav></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview sidebar-panel sidebar-panel-active"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="David"><p class="site-author-name" itemprop="name">David</p><p class="site-description motion-element" itemprop="description">Develop Notes</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">151</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags"><span class="site-state-item-count">37</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/zsr" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/u/2214956781" target="_blank" title="Weibo"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">David</span></div><div class="powered-by"> 由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="theme-info"> 主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),s=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!0,s=r.title.trim().toLowerCase(),n=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),i=r.url,o=-1,l=-1,p=-1;if(""!=s&&""!=n&&a.forEach(function(e,t){o=s.indexOf(e),l=n.indexOf(e),o<0&&l<0?c=!1:(l<0&&(l=0),0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+i+"' class='search-result-title'>"+s+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;u<0&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),s.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script></body></html>