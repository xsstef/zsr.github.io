<!doctype html><html class="theme-next pisces use-motion"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css"><meta name="keywords" content="Hexo, NexT"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1"><meta name="description" content="Develop Notes"><meta property="og:type" content="website"><meta property="og:title" content="Hello Coder"><meta property="og:url" content="http://zsr.github.io/index.html"><meta property="og:site_name" content="Hello Coder"><meta property="og:description" content="Develop Notes"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Hello Coder"><meta name="twitter:description" content="Develop Notes"><script type="text/javascript" id="hexo.configuration">var NexT=window.NexT||{},CONFIG={scheme:"Pisces",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:0,author:"博主"}}</script><link rel="canonical" href="http://zsr.github.io/"><title> Hello Coder</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-81477846-1","auto"),ga("send","pageview")</script><div class="container one-collumn sidebar-position-left page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Hello Coder</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div> <span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/12/14/java-和netty-epoll实现/" itemprop="url">java 和netty epoll实现</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2018-12-14T18:03:02+08:00" content="2018-12-14">2018-12-14</time></span></div></header><div class="post-body" itemprop="articleBody"><p><code>Java NIO</code>根据操作系统不同， 针对<code>Selector</code>有不同的默认实现：</p><ul><li><strong>macosx</strong>：KQueueSelectorProvider</li><li><strong>solaris</strong>：DevPollSelectorProvider</li><li><strong>Linux</strong>：EPollSelectorProvider (Linux kernels &gt;= 2.6)或 PollSelectorProvider</li><li><strong>windows</strong>： WindowsSelectorProvider</li></ul><h3 id="为什么netty还要提供一个基于epoll的实现"><a href="#为什么netty还要提供一个基于epoll的实现" class="headerlink" title="为什么netty还要提供一个基于epoll的实现"></a>为什么<code>netty</code>还要提供一个基于<code>epoll</code>的实现</h3><p>自4.0.16起, <code>Netty</code>为<code>Linux</code>通过<code>JNI</code>的方式提供了<code>native socket transport</code>.</p><ul><li><code>NioEventLoopGroup</code> → <code>EpollEventLoopGroup</code></li><li><code>NioEventLoop</code> → <code>EpollEventLoop</code></li><li><code>NioServerSocketChannel</code> → <code>EpollServerSocketChannel</code></li><li><code>NioSocketChannel</code> → <code>EpollSocketChannel</code></li></ul><p><strong>原因：</strong></p><ol><li><code>Netty</code>的 <code>epoll transport</code>使用 <code>epoll</code>边缘触发 而 <code>java nio</code> 使用 <code>epoll</code>水平触发（在这个模式下，io来了数据，就只通知这些io设备对应的fd，上次通知过的fd不再通知，内核不用扫描一大堆fd）</li><li><code>netty epoll transport</code> 暴露了更多的<code>java nio</code>没有的配置参数， 如 <code>TCP_CORK</code>, <code>SO_REUSEADDR</code>等</li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://netty.io/wiki/native-transports.html" target="_blank" rel="external">Netty native transports</a></p><p><a href="https://stackoverflow.com/questions/23465401/why-native-epoll-support-is-introduced-in-netty" target="_blank" rel="external">Why native epoll support is introduced in Netty?</a></p><p><a href="https://www.cnblogs.com/tianhangzhang/p/5374034.html" target="_blank" rel="external">高性能网络服务器编程：为什么linux下epoll是最好，Netty要比NIO好？</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/12/14/Netty-Server-Demo/" itemprop="url">Netty Server Demo</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2018-12-14T17:15:39+08:00" content="2018-12-14">2018-12-14</time></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="Maven添加依赖"><a href="#Maven添加依赖" class="headerlink" title="Maven添加依赖"></a><code>Maven</code>添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.29.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><h3 id="Server-Demo"><a href="#Server-Demo" class="headerlink" title="Server Demo"></a><code>Server Demo</code></h3><h4 id="模拟请求-响应model"><a href="#模拟请求-响应model" class="headerlink" title="模拟请求/响应model"></a>模拟请求/响应<code>model</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.zsr.test.netty;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestData</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> intValue;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIntValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> intValue;</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIntValue</span><span class="params">(<span class="keyword">int</span> intValue)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.intValue = intValue;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// return RequestData inValue * 2</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseData</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> intValue;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIntValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> intValue;</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIntValue</span><span class="params">(<span class="keyword">int</span> intValue)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.intValue = intValue;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="服务端对请求解码"><a href="#服务端对请求解码" class="headerlink" title="服务端对请求解码"></a>服务端对请求解码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerRequestDecoder</span> <span class="keyword">extends</span> <span class="title">ReplayingDecoder</span>&lt;<span class="title">RequestData</span>&gt; </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    RequestData data = <span class="keyword">new</span> RequestData();</div><div class="line">    data.setIntValue(in.readInt());</div><div class="line">    out.add(data);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="服务端对响应编码"><a href="#服务端对响应编码" class="headerlink" title="服务端对响应编码"></a>服务端对响应编码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerResponseEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">ResponseData</span>&gt; </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, ResponseData msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    out.writeInt(msg.getIntValue());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="服务端具体业务处理"><a href="#服务端具体业务处理" class="headerlink" title="服务端具体业务处理"></a>服务端具体业务处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerProcessingHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    RequestData requestData = (RequestData) msg;</div><div class="line">    ResponseData responseData = <span class="keyword">new</span> ResponseData();</div><div class="line">    responseData.setIntValue(requestData.getIntValue() * <span class="number">2</span>);</div><div class="line">    ctx.writeAndFlush(responseData);</div><div class="line">    System.out.println(<span class="string">"server receive request: "</span> + requestData.getIntValue());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyTestServer</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">new</span> NettyTestServer(<span class="number">8080</span>).start();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</div><div class="line">    EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</div><div class="line">      bootstrap.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)</div><div class="line">          .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">              ch.pipeline().addLast(<span class="keyword">new</span> ServerRequestDecoder(), <span class="keyword">new</span> ServerResponseEncoder(),</div><div class="line">                  <span class="keyword">new</span> ServerProcessingHandler());</div><div class="line">            &#125;</div><div class="line">          &#125;).option(ChannelOption.SO_BACKLOG, <span class="number">128</span>).childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">      ChannelFuture channelFuture = bootstrap.bind(<span class="keyword">new</span> InetSocketAddress(port)).sync();</div><div class="line">      System.out.println(</div><div class="line">          NettyTestServer.class.getName() + <span class="string">" started and listen on "</span> + channelFuture.channel().localAddress());</div><div class="line"></div><div class="line">      channelFuture.channel().closeFuture().sync();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      workerGroup.shutdownGracefully();</div><div class="line">      bossGroup.shutdownGracefully();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.baeldung.com/netty" target="_blank" rel="external">Introduction to Netty</a></p><p><a href="https://sylvanassun.github.io/2017/11/30/2017-11-30-netty_introduction/" target="_blank" rel="external">Netty的那点事儿</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/12/12/Netty初探/" itemprop="url">Netty初探</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2018-12-12T18:27:22+08:00" content="2018-12-12">2018-12-12</time></span></div></header><div class="post-body" itemprop="articleBody"><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Netty is an asynchronous event-driven network application framework for rapid development of maintainable high performance protocol servers &amp; clients.</div><div class="line"></div><div class="line">Netty is a NIO client server framework which enables quick and easy development of network applications such as protocol servers and clients. It greatly simplifies and streamlines network programming such as TCP and UDP socket server.</div></pre></td></tr></table></figure><h3 id="为什么不选择JAVA原生NIO"><a href="#为什么不选择JAVA原生NIO" class="headerlink" title="为什么不选择JAVA原生NIO"></a>为什么不选择<code>JAVA</code>原生<code>NIO</code></h3><ul><li><code>NIO</code> 的类库和 <code>API</code> 繁杂，使用麻烦：需要熟练掌握 <code>Selector</code>、<code>ServerSocketChannel</code>、<code>SocketChannel</code>、<code>ByteBuffer</code>等。</li><li>编写出高质量的 <code>NIO</code> 程序需要具备其他的额外技能做铺垫：例如熟悉 <code>Java</code> 多线程编程，因为 <code>NIO</code> 编程涉及到 <code>Reactor</code> 模式，必须对多线程和网路编程非常熟悉。</li><li><code>NIO</code> 编程的特点是功能开发相对容易，但是可靠性能力补齐工作量和难度都非常大：例如客户端面临断连重连、网络闪断、半包读写、失败缓存、网络拥塞和异常码流的处理等等。</li><li><a href="http://www.10tiao.com/html/308/201602/401718035/1.html" target="_blank" rel="external"><code>JDK NIO</code>的 <code>Epoll Bug</code>，它会导致<code>Selector</code>空轮询，最终导致<code>CPU 100%</code></a></li></ul><h3 id="为什么选择Netty"><a href="#为什么选择Netty" class="headerlink" title="为什么选择Netty"></a>为什么选择<code>Netty</code></h3><ul><li><code>API</code>使用简单，开发门槛低；</li><li>功能强大，预置了多种编解码功能，支持多种主流协议；</li><li><strong>定制能力强，可以通过ChannelHandler对通信框架进行灵活地扩展；</strong></li><li>性能高，通过与其他业界主流的<code>NIO</code>框架对比，Netty的综合性能最优；</li><li>成熟、稳定，<code>Netty</code>修复了已经发现的所有<code>JDK NIO BUG</code>；</li></ul><h3 id="Netty架构设计"><a href="#Netty架构设计" class="headerlink" title="Netty架构设计"></a><code>Netty</code>架构设计</h3><p><code>Netty</code>采用了比较典型的三层网络架构进行设计，逻辑架构图如下所示：</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy53lm41bjj30ts0fytgt.jpg" alt=""></p><ul><li>传输服务：支持 <code>BIO</code> 和 <code>NIO</code></li><li>容器集成：支持 <code>OSGI</code>、<code>JBossMC</code>、<code>Spring</code>、<code>Guice</code>容器</li><li>协议支持：<code>HTTP</code>、<code>Protobuf</code>、二进制、<code>WebSocket</code>等一系列常见协议都支持。还支持通过实行编码解码逻辑来实现自定义协议</li><li><code>Core</code> 核心：可扩展事件模型、通用通信 <code>API</code>、支持零拷贝的 <code>ByteBuf</code> 缓冲对象</li></ul><h3 id="高性能的三大要素"><a href="#高性能的三大要素" class="headerlink" title="高性能的三大要素"></a><strong>高性能的三大要素</strong></h3><ol><li><strong>传输</strong>：用什么样的通道将数据发送给对方，BIO、NIO 或者 AIO，<strong>IO 模型在很大程度上决定了框架的性能</strong>。</li><li><strong>协议</strong>：采用什么样的通信协议，<code>HTTP</code> 或者内部私有协议。协议的选择不同，性能模型也不同。相比于公有协议，内部私有协议的性能通常可以被设计的更优。</li><li><strong>线程模型</strong>：数据报如何读取？读取之后的编解码在哪个线程进行，编解码后的消息如何派发，<code>Reactor</code> 线程模型的不同，对性能的影响也非常大。</li></ol><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy53swbgjzj30rc0nwdk8.jpg" alt=""></p><h3 id="Netty高性能原因"><a href="#Netty高性能原因" class="headerlink" title="Netty高性能原因"></a><code>Netty</code>高性能原因</h3><h4 id="IO模型"><a href="#IO模型" class="headerlink" title="IO模型"></a><strong>IO模型</strong></h4><p><code>Netty</code>的IO线程<code>NioEventLoop</code>由于聚合了多路复用器<code>Selector</code>，可以同时并发处理成百上千个客户端<code>Channel</code>，由于读写操作都是非阻塞的，这就可以充分提升IO线程的运行效率，避免由于频繁IO阻塞导致的线程挂起</p><h4 id="零拷贝"><a href="#零拷贝" class="headerlink" title="零拷贝"></a>零拷贝</h4><p><strong>在后面的文章专门详解</strong></p><h4 id="内存池"><a href="#内存池" class="headerlink" title="内存池"></a>内存池</h4><p><strong>在后面的文章专门详解</strong></p><h4 id="Netty-线程模型"><a href="#Netty-线程模型" class="headerlink" title="Netty 线程模型"></a><strong>Netty 线程模型</strong></h4><p><code>Netty</code> 主要基于主从 <code>Reactor</code> 多线程模型（如下图）做了一定的修改，其中主从 <code>Reactor</code> 多线程模型有多个 <code>Reactor</code>：</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy548sanm2j30rk0iwh0n.jpg" alt=""></p><ul><li><code>MainReactor</code>负责客户端的连接请求，并将请求转交给 <code>SubReactor</code></li><li><code>SubReactor</code>负责相应通道的IO读写请求</li><li>非IO请求（具体逻辑处理）等待 <code>worker threads</code> 进行处理</li></ul><p><strong>注意：<code>Netty</code> 的线程模型基于主从 <code>Reactor</code>多线程，借用了 <code>MainReactor</code> 和 <code>SubReactor</code> 的结构。但是<code>Netty</code>实际实现上 <code>SubReactor</code> 和 <code>Worker</code> 线程在同一个线程池中</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(); </div><div class="line">EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(); </div><div class="line">ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap(); </div><div class="line">bootstrap.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)</div></pre></td></tr></table></figure><p><code>Netty</code>里对应<code>mainReactor</code>的角色叫做<code>Boss</code>，而对应<code>subReactor</code>的角色叫做<code>Worker</code></p><p><code>bossGroup</code> 和 <code>workerGroup</code> 这两个 <code>group</code> 均是线程池：</p><ul><li><code>bossGroup</code> 线程池则只是在 <code>Bind</code> 某个端口后，获得其中一个线程作为 <code>MainReactor</code>，专门处理端口的 <code>Accept</code> 事件</li><li><code>workerGroup</code> 线程池会被各个<code>SubReactor</code> 和 <code>Worker</code> 线程充分利用</li></ul><h3 id="Netty线程模型"><a href="#Netty线程模型" class="headerlink" title="Netty线程模型"></a>Netty线程模型</h3><p>下图来自组内大牛分享，盗来使用～～：</p><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fy6dbsx3k1j31d60sok1f.jpg" alt=""></p><p><strong>注意：服务器端的 <code>ServerSocketChannel</code> 只绑定到了 <code>bossGroup</code> 中的一个线程, 因此在调用<code>Selector.select</code> 处理客户端的连接请求时, 实际上是在一个线程中的, 所以对只有一个服务(监听一个端口)的应用来说, <code>bossGroup</code> 设置多个线程是没有什么作用的, 反而还会造成资源浪费。</strong></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.baeldung.com/netty" target="_blank" rel="external">Introduction to Netty</a></p><p><a href="https://sylvanassun.github.io/2017/11/30/2017-11-30-netty_introduction/" target="_blank" rel="external">Netty的那点事儿</a></p><p><a href="https://xiaozhuanlan.com/topic/2153098467" target="_blank" rel="external">NIO Reactor 模型 &amp; Netty 线程模型</a></p><p><a href="https://stackoverflow.com/questions/22280916/do-we-need-more-than-a-single-thread-for-boss-group" target="_blank" rel="external">do we need more than a single thread for boss group?</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/12/07/Reactor-模型/" itemprop="url">Reactor 模型</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2018-12-07T11:10:16+08:00" content="2018-12-07">2018-12-07</time></span></div></header><div class="post-body" itemprop="articleBody"><p>服务端如何处理请求：后端接收到一个请求，简化下会做以下四个操作：</p><ol><li><strong>建立连接</strong></li><li><strong>读取数据</strong></li><li><strong>业务操作</strong></li><li><strong>写回数据</strong></li></ol><p><strong>Reactor的核心思想</strong>：<code>Reactor</code> 模式也叫 <code>Dispatcher</code> 模式，将关注的IO事件注册到多路复用器上，一旦有IO事件触发，将事件分发到事件处理器中，执行就绪IO事件对应的处理函数中。模型中有三个重要的组件：</p><ul><li><code>Reactor</code>：在一个单独的线程中运行，负责监听和分发事件，分发给适当的处理程序来对 IO 事件做出反应。</li><li><code>Handlers</code>：处理程序执行IO事件要完成的实际事件，<code>Reactor</code>通过调度处理程序来响应IO事件，处理程序执行非阻塞操作。</li></ul><h3 id="Reactor模式演进"><a href="#Reactor模式演进" class="headerlink" title="Reactor模式演进"></a><a href="http://gee.cs.oswego.edu/dl/cpjslides/nio.pdf" target="_blank" rel="external">Reactor模式演进</a></h3><p><code>Reactor</code> 模型取决于 <code>Reactor</code> 的数量和 <code>Hanndler</code> 线程数量的不同，<code>Reactor</code> 模型有 3 个变种：</p><ul><li>单线程<code>Reactor</code>模式：单<code>Reactor</code>单线程<code>Hanndler</code></li><li>多线程<code>Reactor</code>模式：单<code>Reactor</code>多线程<code>Hanndler</code></li><li>主从<code>Reactor</code>模式：主从<code>Reactor</code>多线程<code>Hanndler</code></li></ul><p><code>Reactor</code> 就是一个执行 <code>while (true) { selector.select(); …}</code> 循环的线程，会源源不断的产生新的事件，称作反应堆很贴切。</p><h4 id="单线程Reactor模式"><a href="#单线程Reactor模式" class="headerlink" title="单线程Reactor模式"></a>单线程<code>Reactor</code>模式</h4><p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy1i62jskoj31la0muk05.jpg" alt=""></p><p>单线程<code>Reactor</code>模式 : 建立连接，读取/写回数据和业务操作都在同一个<code>Reactor</code>线程中执行，虽然<code>Reactor</code>的读取写回不会造成阻塞，但是业务操作就很可能造成阻塞；并且单线程不能充分利用<code>CPU</code>多核优势，因此处理能力是有限的，对于小量连接情况下问题不大，对于大量链接情况下，单个<code>NIO</code>线程因处理能力有限会导致连接大量超时。</p><h4 id="多线程Reactor模式"><a href="#多线程Reactor模式" class="headerlink" title="多线程Reactor模式"></a>多线程<code>Reactor</code>模式</h4><p>将非IO的业务逻辑操作从<code>Reactor</code>线程上卸载，以此来加速<code>Reactor</code>线程对IO请求的响应。</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fy2txzpfcwj30rs0jjqdo.jpg" alt=""></p><p>多线程<code>Reactor</code>模式：多线程模式下把业务操作（<code>decode</code>，<code>compute</code>，<code>encode</code>）等放到线程池中处理，保证<code>Reactor</code>线程不会阻塞，而<code>Reactor</code>仍为单个线程仍然要处理连接和读取/写回操作，其承担连接负载量上来时仍然承受很大压力（例如并发百万客户端连接，或者服务端需要对客户端握手进行安全认证，但是认证本身非常损耗性能）</p><h3 id="主从Reactor模式"><a href="#主从Reactor模式" class="headerlink" title="主从Reactor模式"></a>主从<code>Reactor</code>模式</h3><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fy3sy13x4cj312u0r847b.jpg" alt=""></p><p>主从<code>Reactor</code>模式：相比多线程<code>Reactor</code>模式，主从<code>Reactor</code>模式下把IO读取/写回两个操作放在 <strong>从Reactor线程池</strong> 中执行， <strong>主Reactor线程</strong>也就是<code>Acceptor</code>只负责建立连接，建立之后将其注册到 <strong>从Reactor线程</strong> 中，因此大大提高了负载能力。同时为了避免并发问题还要保证一个连接只能注册一个<code>Reactor</code>线程上</p><ul><li><code>MainReactor</code>负责客户端的连接请求，并将请求转交给 <code>SubReactor</code></li><li><code>SubReactor</code>负责相应通道的IO读写操作</li><li>非IO请求（具体逻辑处理）的任务则会交由工作线程池处理</li></ul><p><strong>好处：因为subReactor也会执行一些比较耗时的IO操作，例如消息的读写，使用多个线程去执行，则更加有利于发挥CPU的运算能力，减少IO等待时间。</strong></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://gee.cs.oswego.edu/dl/cpjslides/nio.pdf" target="_blank" rel="external">Scalable IO in Java</a></p><p><a href="http://www.liuhaihua.cn/archives/530938.html" target="_blank" rel="external">Netty–Reactor模型的应用</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/2018/12/04/Java-NIO-Selector详解/" itemprop="url">Java NIO:Selector详解</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2018-12-04T14:44:01+08:00" content="2018-12-04">2018-12-04</time></span></div></header><div class="post-body" itemprop="articleBody"><p><code>Selector</code>事件分发器(单线程选择就绪的事件)作为Java NIO的核心组件，这里详细了解内部实现</p><h3 id="服务端代码"><a href="#服务端代码" class="headerlink" title="服务端代码"></a>服务端代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">ServerSocketChannel serverChannel = ServerSocketChannel.open();</div><div class="line">serverChannel.configureBlocking(<span class="keyword">false</span>);</div><div class="line">serverChannel.socket().bind(<span class="keyword">new</span> InetSocketAddress(port));</div><div class="line">Selector selector = Selector.open();</div><div class="line">serverChannel.register(selector, SelectionKey.OP_ACCEPT);</div><div class="line"><span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</div><div class="line">    selector.select();</div><div class="line">    Iterator iter = <span class="keyword">this</span>.selector.selectedKeys().iterator();</div><div class="line">    <span class="keyword">while</span>(iter.hasNext())&#123;</div><div class="line">        SelectionKey key = (SelectionKey)iter.next();</div><div class="line">        <span class="keyword">if</span> (key.isAcceptable())&#123;</div><div class="line">            SocketChannel clientChannel = ((ServerSocketChannel) key.channel()).accept();</div><div class="line">            clientChannel.configureBlocking(<span class="keyword">false</span>);</div><div class="line">            <span class="comment">// 监听客户端socket可读就绪事件</span></div><div class="line">            client.register(selector, SelectionKey.OP_READ);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (key.isReadable())&#123;</div><div class="line">            handleRead(key);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (key.isWritable() &amp;&amp; key.isValid())&#123;</div><div class="line">            handleWrite(key);</div><div class="line">        &#125;</div><div class="line">      iter.remove();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ol><li>如果有客户端A连接服务，执行<code>select</code>方法时，可以通过<code>serverSocketChannel</code>获取客户端A的<code>socketChannel</code>，并在<code>selector</code>上注册<code>socketChannel</code>的<code>OP_READ</code>事件。</li><li>如果客户端A发送数据，会触发<code>OP_READ</code>事件，这样下次轮询调用<code>select</code>方法时，就能通过<code>socketChannel</code>读取数据，同时在<code>selector</code>上注册该<code>socketChannel</code>的<code>OP_WRITE</code>事件，实现服务器往客户端写数据。</li></ol><h3 id="Selector-open-实现原理"><a href="#Selector-open-实现原理" class="headerlink" title="Selector.open()实现原理"></a><code>Selector.open()</code>实现原理</h3><p><strong>注意：以下源代码皆来源于<code>openjdk8</code></strong></p><ul><li><code>Selector.open()</code>可以得到一个<code>Selector</code>实例</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Selector <span class="title">open</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">// 首先找到provider,然后再打开Selector</span></div><div class="line">    <span class="keyword">return</span> SelectorProvider.provider().openSelector();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// java.nio.channels.spi.SelectorProvider</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SelectorProvider <span class="title">provider</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">        <span class="keyword">if</span> (provider != <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> provider;</div><div class="line">        <span class="keyword">return</span> AccessController.doPrivileged(</div><div class="line">            <span class="keyword">new</span> PrivilegedAction&lt;SelectorProvider&gt;() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> SelectorProvider <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        <span class="keyword">if</span> (loadProviderFromProperty())</div><div class="line">                            <span class="keyword">return</span> provider;</div><div class="line">                        <span class="keyword">if</span> (loadProviderAsService())</div><div class="line">                            <span class="keyword">return</span> provider;</div><div class="line">                            <span class="comment">// 实际创建SelectorProvider的方法</span></div><div class="line">                        provider = sun.nio.ch.DefaultSelectorProvider.create();</div><div class="line">                        <span class="keyword">return</span> provider;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li><code>sun.nio.ch.DefaultSelectorProvider</code></li></ul><p>不同系统对应着不同的<code>sun.nio.ch.DefaultSelectorProvider</code>，以<code>Linux</code>为例:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Returns the default SelectorProvider.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SelectorProvider <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// 获取OS名称</span></div><div class="line">    String osname = AccessController</div><div class="line">        .doPrivileged(<span class="keyword">new</span> GetPropertyAction(<span class="string">"os.name"</span>));</div><div class="line">    <span class="comment">// 根据名称来创建不同的Selctor</span></div><div class="line">    <span class="keyword">if</span> (osname.equals(<span class="string">"SunOS"</span>))</div><div class="line">        <span class="keyword">return</span> createProvider(<span class="string">"sun.nio.ch.DevPollSelectorProvider"</span>);</div><div class="line">    <span class="keyword">if</span> (osname.equals(<span class="string">"Linux"</span>))</div><div class="line">        <span class="keyword">return</span> createProvider(<span class="string">"sun.nio.ch.EPollSelectorProvider"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> sun.nio.ch.PollSelectorProvider();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>如果系统名称是<code>Linux</code>的话，真正创建的是<code>sun.nio.ch.EPollSelectorProvider</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// EPollSelectorProvider.openSelector()</span></div><div class="line"><span class="function"><span class="keyword">public</span> AbstractSelector <span class="title">openSelector</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> EPollSelectorImpl(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><code>Linux</code>最终的<code>Selector</code>实现:<code>sun.nio.ch.EPollSelectorImpl</code></p><h3 id="EPollSelectorImpl-select-实现原理"><a href="#EPollSelectorImpl-select-实现原理" class="headerlink" title="EPollSelectorImpl.select()实现原理"></a><code>EPollSelectorImpl.select()</code>实现原理</h3><p><code>epoll</code>系统调用主要分为3个函数: <code>epoll_create</code>, <code>epoll_ctl</code>, <code>epoll_wait</code></p><h4 id="epoll-create：创建一个epoll-fd"><a href="#epoll-create：创建一个epoll-fd" class="headerlink" title="epoll_create：创建一个epoll fd"></a><code>epoll_create</code>：创建一个<code>epoll fd</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// class EPollSelectorImpl extends SelectorImpl</span></div><div class="line">EPollSelectorImpl(SelectorProvider sp) <span class="keyword">throws</span> IOException &#123;</div><div class="line">        <span class="keyword">super</span>(sp);</div><div class="line">        <span class="comment">// makePipe返回管道的2个文件描述符，编码在一个long类型的变量中</span></div><div class="line">        <span class="comment">// 高32位代表读 低32位代表写</span></div><div class="line">        <span class="comment">// 使用pipe为了实现Selector的wakeup逻辑</span></div><div class="line">        <span class="keyword">long</span> pipeFds = IOUtil.makePipe(<span class="keyword">false</span>);</div><div class="line">        fd0 = (<span class="keyword">int</span>) (pipeFds &gt;&gt;&gt; <span class="number">32</span>);</div><div class="line">        fd1 = (<span class="keyword">int</span>) pipeFds;</div><div class="line">        <span class="comment">// 创建一个EPollArrayWrapper</span></div><div class="line">        pollWrapper = <span class="keyword">new</span> EPollArrayWrapper();</div><div class="line">        pollWrapper.initInterrupt(fd0, fd1);</div><div class="line">        fdToKey = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p> 创建一个<code>EPollArrayWrapper</code> 初始化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">EPollArrayWrapper() <span class="keyword">throws</span> IOException &#123;</div><div class="line">    <span class="comment">// 创建epoll fd</span></div><div class="line">    epfd = epollCreate();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">epollCreate</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure><p>在初始化过程中调用了<code>native epollCreate</code>方法。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Java_sun_nio_ch_EPollArrayWrapper_epollCreate(JNIEnv *env, jobject <span class="keyword">this</span>)</div><div class="line">&#123;</div><div class="line">     <span class="comment">//从Linux2.6.8之后，改用了红黑树结构，指定了大小也没用</span></div><div class="line">    <span class="keyword">int</span> epfd = epoll_create(<span class="number">256</span>);</div><div class="line">    <span class="keyword">if</span> (epfd &lt; <span class="number">0</span>) &#123;</div><div class="line">       JNU_ThrowIOExceptionWithLastError(env, <span class="string">"epoll_create failed"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> epfd;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><strong><code>epoll_create</code>: 内核系统调用，创建一个<code>epoll fd</code>, 并且开辟epoll自己的内核高速cache区，建立红黑树分配初始size的内存对象，同时建立一个list链表，用于存储准备就绪的事件</strong></p><h4 id="Epoll-wait-等待内核IO事件"><a href="#Epoll-wait-等待内核IO事件" class="headerlink" title="Epoll wait:等待内核IO事件"></a><code>Epoll wait</code>:等待内核IO事件</h4><p>调用<code>Selector.select()</code>,最后会委托给<code>EPollSelectorImpl</code>的<code>doSelect()</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doSelect</span><span class="params">(<span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (closed)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClosedSelectorException();</div><div class="line">    processDeregisterQueue();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        begin();</div><div class="line">        <span class="comment">// 等待事件到来，收集事件到来的fd并用来处理</span></div><div class="line">        pollWrapper.poll(timeout);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        end();</div><div class="line">    &#125;</div><div class="line">    processDeregisterQueue();</div><div class="line">    <span class="keyword">int</span> numKeysUpdated = updateSelectedKeys();</div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (pollWrapper.interrupted()) &#123;</div><div class="line">        <span class="comment">// Clear the wakeup pipe</span></div><div class="line">        pollWrapper.putEventOps(pollWrapper.interruptedIndex(), <span class="number">0</span>);</div><div class="line">        <span class="keyword">synchronized</span> (interruptLock) &#123;</div><div class="line">            pollWrapper.clearInterrupted();</div><div class="line">            IOUtil.drain(fd0);</div><div class="line">            interruptTriggered = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> numKeysUpdated;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>实际执行<code>EPollArrayWrapper.poll(timeout);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">poll</span><span class="params">(<span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">// 看下文</span></div><div class="line">    updateRegistrations();</div><div class="line">    <span class="comment">// 调用native方法，发起系统内核调用</span></div><div class="line">    updated = epollWait(pollArrayAddress, NUM_EPOLLEVENTS, timeout, epfd);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;updated; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (getDescriptor(i) == incomingInterruptFD) &#123;</div><div class="line">            interruptedIndex = i;</div><div class="line">            interrupted = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> updated;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">epollWait</span><span class="params">(<span class="keyword">long</span> pollAddress, <span class="keyword">int</span> numfds, <span class="keyword">long</span> timeout,</span></span></div><div class="line">                             <span class="keyword">int</span> epfd) <span class="keyword">throws</span> IOException;</div></pre></td></tr></table></figure><p><code>epollWait</code>也是个<code>native</code>方法:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Java_sun_nio_ch_EPollArrayWrapper_epollWait(JNIEnv *env, jobject <span class="keyword">this</span>,</div><div class="line">                                            jlong address, jint numfds,</div><div class="line">                                            jlong timeout, jint epfd)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> epoll_event *events = jlong_to_ptr(address);</div><div class="line">    <span class="keyword">int</span> res;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (timeout &lt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 发起epoll_wait系统调用等待内核事件</span></div><div class="line">        RESTARTABLE(epoll_wait(epfd, events, numfds, timeout), res);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        res = iepoll(epfd, events, numfds, timeout);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</div><div class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"epoll_wait failed"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> res;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><strong><code>epoll_wait</code>: 内核系统调用, 等待内核返回IO事件</strong></p><h4 id="epoll-ctl-IO事件管理"><a href="#epoll-ctl-IO事件管理" class="headerlink" title="epoll_ctl: IO事件管理"></a><code>epoll_ctl</code>: IO事件管理</h4><p>注册到<code>Selector</code>上的IO事件是使用<code>SelectionKey</code>来表示，代表了<code>Channel</code>感兴趣的事件，如<code>Read</code>,<code>Write</code>,<code>Connect</code>,<code>Accept</code>.</p><p>调用<code>Selector.register()</code>完成IO事件注册，实际执行<code>EPollSelectorImpl.implRegister()</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">implRegister</span><span class="params">(SelectionKeyImpl ski)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (closed)</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> ClosedSelectorException();</div><div class="line">       SelChImpl ch = ski.channel;</div><div class="line">       <span class="keyword">int</span> fd = Integer.valueOf(ch.getFDVal());</div><div class="line">       fdToKey.put(fd, ski);</div><div class="line">       pollWrapper.add(fd);</div><div class="line">       keys.add(ski);</div><div class="line">   &#125;</div></pre></td></tr></table></figure><p>调用<code>Selector.register()</code>时均会将事件存储到<code>EpollArrayWrapper</code>的成员变量<code>eventsLow</code>和<code>eventsHigh</code>中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 使用数组保存事件变更, 数组的最大长度是MAX_UPDATE_ARRAY_SIZE, 最大64*1024</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] eventsLow = <span class="keyword">new</span> <span class="keyword">byte</span>[MAX_UPDATE_ARRAY_SIZE];</div><div class="line"><span class="comment">// 超过数组长度的事件会缓存到这个map中，等待下次处理</span></div><div class="line"><span class="keyword">private</span> Map&lt;Integer,Byte&gt; eventsHigh;</div><div class="line"></div><div class="line"><span class="comment">// 添加文件描述符fd</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>&#123;</div><div class="line">        <span class="comment">// force the initial update events to 0 as it may be KILLED by a</span></div><div class="line">        <span class="comment">// previous registration.</span></div><div class="line">        <span class="keyword">synchronized</span> (updateLock) &#123;</div><div class="line">            <span class="keyword">assert</span> !registered.get(fd);</div><div class="line">            setUpdateEvents(fd, (<span class="keyword">byte</span>)<span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setUpdateEvents</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">byte</span> events, <span class="keyword">boolean</span> force)</span> </span>&#123;</div><div class="line">    <span class="comment">// 判断fd和数组长度</span></div><div class="line">    <span class="keyword">if</span> (fd &lt; MAX_UPDATE_ARRAY_SIZE) &#123;</div><div class="line">        <span class="keyword">if</span> ((eventsLow[fd] != KILLED) || force) &#123;</div><div class="line">            eventsLow[fd] = events;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Integer key = Integer.valueOf(fd);</div><div class="line">        <span class="keyword">if</span> (!isEventsHighKilled(key) || force) &#123;</div><div class="line">            eventsHigh.put(key, Byte.valueOf(events));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>执行<code>EpollArrayWrapper.poll()</code>的时候, 首先会调用<code>updateRegistrations()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Returns the pending update events for the given file descriptor.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">byte</span> <span class="title">getUpdateEvents</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (fd &lt; MAX_UPDATE_ARRAY_SIZE) &#123;</div><div class="line">        <span class="keyword">return</span> eventsLow[fd];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Byte result = eventsHigh.get(Integer.valueOf(fd));</div><div class="line">        <span class="comment">// result should never be null</span></div><div class="line">        <span class="keyword">return</span> result.byteValue();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateRegistrations</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (updateLock) &#123;</div><div class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (j &lt; updateCount) &#123;</div><div class="line">            <span class="keyword">int</span> fd = updateDescriptors[j];</div><div class="line">            <span class="comment">// 从保存的eventsLow和eventsHigh里取出事件</span></div><div class="line">            <span class="keyword">short</span> events = getUpdateEvents(fd);</div><div class="line">            <span class="keyword">boolean</span> isRegistered = registered.get(fd);</div><div class="line">            <span class="keyword">int</span> opcode = <span class="number">0</span>;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (events != KILLED) &#123;</div><div class="line">                <span class="comment">// 判断操作类型以传给epoll_ctl</span></div><div class="line">                <span class="comment">// 没有指定EPOLLET事件类型</span></div><div class="line">                <span class="keyword">if</span> (isRegistered) &#123;</div><div class="line">                    <span class="comment">// 如果已经注册过，不需要调用epollCtl去内核红黑树新增节点</span></div><div class="line">                    opcode = (events != <span class="number">0</span>) ? EPOLL_CTL_MOD : EPOLL_CTL_DEL;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    opcode = (events != <span class="number">0</span>) ? EPOLL_CTL_ADD : <span class="number">0</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (opcode != <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// 熟悉的epoll_ctl</span></div><div class="line">                    epollCtl(epfd, opcode, fd, events);</div><div class="line">                    <span class="keyword">if</span> (opcode == EPOLL_CTL_ADD) &#123;</div><div class="line">                        registered.set(fd);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opcode == EPOLL_CTL_DEL) &#123;</div><div class="line">                        registered.clear(fd);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            j++;</div><div class="line">        &#125;</div><div class="line">        updateCount = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">epollCtl</span><span class="params">(<span class="keyword">int</span> epfd, <span class="keyword">int</span> opcode, <span class="keyword">int</span> fd, <span class="keyword">int</span> events)</span></span>;</div></pre></td></tr></table></figure><p>在获取到事件之后将操作委托给了<code>epollCtl</code>,这又是个native方法：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Java_sun_nio_ch_EPollArrayWrapper_epollCtl(JNIEnv *env, jobject <span class="keyword">this</span>, jint epfd,</div><div class="line">                                           jint opcode, jint fd, jint events)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> epoll_event event;</div><div class="line">    <span class="keyword">int</span> res;</div><div class="line"></div><div class="line">    event.events = events;</div><div class="line">    event.data.fd = fd;</div><div class="line"></div><div class="line">    <span class="comment">// 发起epoll_ctl调用来进行IO事件的管理</span></div><div class="line">    RESTARTABLE(epoll_ctl(epfd, (<span class="keyword">int</span>)opcode, (<span class="keyword">int</span>)fd, &amp;event), res);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span> &amp;&amp; errno != EBADF &amp;&amp; errno != ENOENT &amp;&amp; errno != EPERM) &#123;</div><div class="line">        JNU_ThrowIOExceptionWithLastError(env, <span class="string">"epoll_ctl failed"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><strong>注意：jdk nio没有指定<code>ET(边缘触发)</code>还是<code>LT(水平触发)</code>, 所以默认会用<code>LT</code>, 而<code>Netty epoll transport</code>使用<code>ET</code>触发</strong></p><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxv38f07maj310g0jmdm2.jpg" alt=""></p><p>通过<code>channel</code>就能不断的获取客户端<code>socket</code>数据，实现后端业务处理</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://juejin.im/entry/5b51546df265da0f70070b93" target="_blank" rel="external">Java NIO分析(8): 高并发核心Selector详解</a></p><p><a href="https://www.jianshu.com/p/7b507069debb" target="_blank" rel="external">java NIO 运行原理介绍</a></p><p><a href="https://www.baeldung.com/java-nio-selector" target="_blank" rel="external">Introduction to the Java NIO Selector</a></p><p><a href="https://www.jianshu.com/p/0d497fe5484a" target="_blank" rel="external">深入浅出NIO之Selector实现原理</a></p><p><a href="http://matt33.com/2017/08/12/java-nio/" target="_blank" rel="external">谈一谈 Java IO 模型</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></article></section><nav class="pagination"> <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/30/">30</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a></nav></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview sidebar-panel sidebar-panel-active"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="David"><p class="site-author-name" itemprop="name">David</p><p class="site-description motion-element" itemprop="description">Develop Notes</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">149</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags"><span class="site-state-item-count">37</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/zsr" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/u/2214956781" target="_blank" title="Weibo"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">David</span></div><div class="powered-by"> 由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="theme-info"> 主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),s=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!0,s=r.title.trim().toLowerCase(),n=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),i=r.url,o=-1,l=-1,p=-1;if(""!=s&&""!=n&&a.forEach(function(e,t){o=s.indexOf(e),l=n.indexOf(e),o<0&&l<0?c=!1:(l<0&&(l=0),0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+i+"' class='search-result-title'>"+s+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;u<0&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),s.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script></body></html>