<!doctype html><html class="theme-next pisces use-motion"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css"><meta name="keywords" content="http,"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1"><meta name="description" content="在跨域情况下（源域名与目的域名不一样），浏览器可能会发起一个HTTP OPTIONS 的请求预检（preflighting）服务端是否支持CORS。如果服务端允许当前域名(源域名)CORS，则浏览器会再发起真正的请求。
跨域请求浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。只要同时满足以下两大条件，就属于简单请求。"><meta property="og:type" content="article"><meta property="og:title" content="浏览器跨域请求"><meta property="og:url" content="http://zsr.github.io/2017/12/14/浏览器跨域请求/index.html"><meta property="og:site_name" content="Hello Coder"><meta property="og:description" content="在跨域情况下（源域名与目的域名不一样），浏览器可能会发起一个HTTP OPTIONS 的请求预检（preflighting）服务端是否支持CORS。如果服务端允许当前域名(源域名)CORS，则浏览器会再发起真正的请求。
跨域请求浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。只要同时满足以下两大条件，就属于简单请求。"><meta property="og:image" content="https://ws4.sinaimg.cn/large/006tKfTcgy1fmomo2jmabj31kw045n0e.jpg"><meta property="og:image" content="https://ws3.sinaimg.cn/large/006tKfTcgy1fmomo3etz5j30za0f6tbg.jpg"><meta property="og:image" content="https://ws2.sinaimg.cn/large/006tKfTcgy1fmomo4slblj30fg03eq32.jpg"><meta property="og:image" content="https://ws4.sinaimg.cn/large/006tKfTcgy1fmomo2zcwoj31kw03641g.jpg"><meta property="og:image" content="https://ws1.sinaimg.cn/large/006tKfTcgy1fmomo3wo7rj312w09240h.jpg"><meta property="og:image" content="https://ws3.sinaimg.cn/large/006tKfTcgy1fmomo4d3wbj31kw026wfq.jpg"><meta property="og:image" content="https://ws2.sinaimg.cn/large/006tKfTcgy1fmomo1pawej31040cego7.jpg"><meta property="og:image" content="https://ws4.sinaimg.cn/large/006tKfTcgy1fmomo20v2qj30t00fotay.jpg"><meta property="og:updated_time" content="2017-12-21T11:53:54.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="浏览器跨域请求"><meta name="twitter:description" content="在跨域情况下（源域名与目的域名不一样），浏览器可能会发起一个HTTP OPTIONS 的请求预检（preflighting）服务端是否支持CORS。如果服务端允许当前域名(源域名)CORS，则浏览器会再发起真正的请求。
跨域请求浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。只要同时满足以下两大条件，就属于简单请求。"><meta name="twitter:image" content="https://ws4.sinaimg.cn/large/006tKfTcgy1fmomo2jmabj31kw045n0e.jpg"><script type="text/javascript" id="hexo.configuration">var NexT=window.NexT||{},CONFIG={scheme:"Pisces",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:0,author:"博主"}}</script><link rel="canonical" href="http://zsr.github.io/2017/12/14/浏览器跨域请求/"><title> 浏览器跨域请求 | Hello Coder</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-81477846-1","auto"),ga("send","pageview")</script><div class="container one-collumn sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Hello Coder</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div> <span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline"> 浏览器跨域请求</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2017-12-14T18:57:34+08:00" content="2017-12-14">2017-12-14</time></span></div></header><div class="post-body" itemprop="articleBody"><p>在跨域情况下（源域名与目的域名不一样），浏览器可能会发起一个<code>HTTP OPTIONS</code> 的请求预检（<code>preflighting</code>）服务端是否支持<code>CORS</code>。如果服务端允许当前域名(源域名)<code>CORS</code>，则浏览器会再发起真正的请求。</p><h3 id="跨域请求"><a href="#跨域请求" class="headerlink" title="跨域请求"></a>跨域请求</h3><p>浏览器将<code>CORS</code>请求分成两类：简单请求（<code>simple request</code>）和非简单请求（<code>not-so-simple request</code>）。只要同时满足以下两大条件，就属于简单请求。</p><ul><li>请求方法是以下三种方法之一：<code>HEAD,GET,POST</code></li><li><code>HTTP</code>的头信息不超出以下几种字段：<ul><li><code>Accept</code></li><li><code>Accept-Language</code></li><li><code>Content-Language</code></li><li><code>Last-Event-ID</code></li><li><code>Content-Type</code>(只限于三个值<code>application/x-www-form-urlencoded</code>、 <code>multipart/form-data</code>、<code>text/plain</code>)</li></ul></li></ul><p>凡是不同时满足上面两个条件，就属于非简单请求。</p><h4 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h4><p>对于简单请求，浏览器直接发出<code>CORS</code>请求。浏览器会自动在头信息(<code>Request Headers</code>)中，添加一个<code>Origin</code> 字段,来表明本次请求来自哪个域。</p><ul><li>如果<code>Origin</code>不在许可范围内，会报错：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">No &apos;Access-Control-Allow-Origin&apos; header is present on the requested resource.</div></pre></td></tr></table></figure><ul><li>如果<code>Origin</code>指定的域名在许可范围内(必须是跨域的），<code>Response Headers</code>中会多出几个头信息字段:</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Access-Control-Allow-Credentials:true //值为true表示允许发送cookie</div><div class="line">Access-Control-Allow-Methods:GET, POST, OPTIONS</div><div class="line">Access-Control-Allow-Origin:http://localhost:8080</div></pre></td></tr></table></figure><p>这几个字端要么在服务器端直接返回，要么配置在<code>nginx</code>中，具体实现看下文</p><ul><li><code>withCredentials</code>属性</li></ul><p><code>CORS</code>默认不发送<code>cookie</code>和<code>http</code>认证，如果要把<code>Cookie</code>发到服务器，就要指定<code>Access-Control-Allow-Credentials:true;</code><strong>另外<code>ajax</code>中也要打开<code>withCredentials</code>属性</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">headers: &#123;</div><div class="line">        withCredentials: true,</div><div class="line">    &#125;,</div></pre></td></tr></table></figure><a id="more"></a><h4 id="非简单请求"><a href="#非简单请求" class="headerlink" title="非简单请求"></a>非简单请求</h4><p>比如：请求方法是<code>PUT</code>或<code>DELETE</code>，或者<code>Content-Type</code>字段的类型是<code>application/json</code></p><p><strong>结果发现浏览器连续向同一地址请求了两次，而第一次请求什么值也没拿到</strong></p><ul><li>第一次请求信息</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">General</div><div class="line">Request URL:http:/mobile.test.ximalaya.com/v1/lesson</div><div class="line">Request Method:OPTIONS  </div><div class="line">Status Code:200 OK</div><div class="line"></div><div class="line">Response Headers</div><div class="line">Access-Control-Request-Headers:content-type  </div><div class="line">Access-Control-Request-Method:GET, POST, OPTIONS  </div><div class="line">Access-Control-Allow-Origin:http://localhost:8080</div><div class="line">Content-Length:0</div></pre></td></tr></table></figure><ul><li>第二次请求信息</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">General</div><div class="line">Request URL:http:/mobile.test.ximalaya.com/v1/lesson</div><div class="line">Request Method:POST  </div><div class="line">Status Code:200 OK</div><div class="line"></div><div class="line">Response Headers</div><div class="line">Access-Control-Request-Headers:content-type  </div><div class="line">Access-Control-Request-Method:GET, POST, OPTIONS  </div><div class="line">Access-Control-Allow-Origin:http://localhost:8080</div></pre></td></tr></table></figure><p>这是因为浏览器发现，这是一个非简单请求，就自动发出一个”预检”请求，要求服务器确认可以这样请求。”预检”请求用的请求方法是<code>OPTIONS</code>，表示这个请求是用来询问的。”预检”请求之后，浏览器球会进行正常<code>CORS</code>请求。</p><h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><h4 id="背景说明"><a href="#背景说明" class="headerlink" title="背景说明"></a>背景说明</h4><p>前端H5通过<code>ajax</code>调用后端<code>restful api</code>，并且页面访问域名与<code>api</code>访问域名(<code>mobile.test.ximalaya.com</code>)不同，导致访问报错:</p><p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fmomo2jmabj31kw045n0e.jpg" alt="05C9331E-30FD-4685-AB61-02F308FC3695"></p><p>出现这种情况的原因如下：</p><ul><li>本次<code>ajax</code>请求是“非简单请求”,所以请求前会发送一次预检请求(OPTIONS)</li><li>服务器端后台接口没有允许OPTIONS请求,导致无法找到对应接口地址</li></ul><h4 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h4><ol><li><strong>前端<code>ajax</code>请求代码</strong></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$.ajax(&#123;</div><div class="line">    url: &apos;http://mobile.test.ximalaya.com/weikemsg-web/v1/room/110001/discuss/send&apos;,</div><div class="line">    headers: &#123;</div><div class="line">        &apos;Content-Type&apos;:&apos;application/json&apos;</div><div class="line">    &#125;,</div><div class="line">    method: &apos;POST&apos;,</div><div class="line">    data: &#123;id = 1&#125;,</div><div class="line">    success: function(data)&#123;</div><div class="line">      console.log(&apos;succes: &apos;+data);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div></pre></td></tr></table></figure><p>这里请求类型使用<code>post</code>，数据类型是<code>json</code></p><ol><li><strong><code>http</code>请求信息</strong></li></ol><p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fmomo3etz5j30za0f6tbg.jpg" alt="F003603E-2FE9-4009-BF3D-CAA5EE0201F9"></p><p>从<code>request header</code>信息中可以发现，实际请求类型是<code>OPTIONS</code>，注意：</p><ul><li><code>Access-Control-Request-Method</code>：在发出预检请求时带有这个头信息, 告诉服务器在实际请求时会使用的请求方式</li><li><code>Access-Control-Request-Headers</code>：在发出预检请求时带有这个头信息, 告诉服务器在实际请求时会携带的自定义头信息. 如有多个, 可以用逗号分开.</li><li><code>Origin</code>：表明发送请求或者预请求的域</li></ul><ol><li><strong>失败分析</strong></li></ol><ul><li><code>Status Code:401</code></li></ul><p>这里的<code>http</code>返回状态码<code>401</code>(未授权)，是因为服务端这边设置了登录验证过滤器，服务端返回结果如下：</p><p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fmomo4slblj30fg03eq32.jpg" alt="F2AFC4E1-4CDE-4B6C-8237-A185565213D9"></p><ul><li>跨域</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Response to preflight request doesn&apos;t pass access control check: No &apos;Access-Control-Allow-Origin&apos; header is present on the requested resource. Origin &apos;http://127.0.0.1:9000&apos; is therefore not allowed access</div></pre></td></tr></table></figure><p>从控制台错误信息中，可以发现浏览器发送的<code>OPTIONS</code>预检请求不允许访问服务器，也就是不允许跨域访问</p><ol><li><strong>第一次尝试解决</strong></li></ol><p><code>Nginx</code>添加如下配置：</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location ^~ /weikemsg-web &#123;</div><div class="line">        add_header 'Access-Control-Allow-Origin' "*"; // 允许所有域名访问</div><div class="line">        add_header 'Access-Control-Allow-Credentials' 'true';  // 允许携带Cookie</div><div class="line">        add_header 'Access-Control-Allow-Methods' 'POST, GET, OPTIONS'; // 支持访问方式</div><div class="line">        proxy_pass http://weikemsg-web/weikemsg-web;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>同时用户先登录，保留<code>Cookie</code>，再次访问目的地址，结果如下：</p><p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fmomo2zcwoj31kw03641g.jpg" alt="01807CD6-DD4D-4F17-BF94-F5F75CE7E93E"></p><p>结果没有任何变化，跨域访问没有成功，服务端还是没有拿到<code>Cookie</code>信息</p><ol><li><strong>第二次尝试解决</strong></li></ol><p><strong>如果<code>http</code>请求需要带上<code>Cookie</code>，必须设置<code>Access-Control-Allow-Credentials</code>为<code>true</code>，同时不能设置<code>Access-Control-Allow-Origin</code>为<code>*</code></strong></p><p>重新配置<code>Nginx</code>:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /weikemsg-web &#123;</div><div class="line">        <span class="attribute">add_header</span> <span class="string">'Access-Control-Allow-Origin'</span> <span class="string">"<span class="variable">$http_origin</span>"</span>;</div><div class="line">        <span class="attribute">add_header</span> <span class="string">'Access-Control-Allow-Credentials'</span> <span class="string">'true'</span>;</div><div class="line">        <span class="attribute">add_header</span> <span class="string">'Access-Control-Allow-Methods'</span> <span class="string">'POST, GET, OPTIONS'</span>;</div><div class="line">        <span class="attribute">proxy_pass</span> http://weikemsg-web/weikemsg-web;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>再次访问，但是结果没有任何变化</p><ol><li><strong>第三次尝试解决</strong></li></ol><p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fmomo3wo7rj312w09240h.jpg" alt="F570147A-895F-4223-AAD5-4E92C885BAB9"></p><p>重新观察请求头信息，浏览器发送<code>OPTIONS</code>请求并没有携带<code>Cookie</code>，该请求进入服务器后被判断未登录，所以一直返回<code>401</code>错误，首先需要解决的是处理<code>OPTIONS</code>请求</p><p>重新配置<code>Nginx</code>:</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">location ^~ /weikemsg-web &#123;</div><div class="line">        if ($request_method = 'OPTIONS') &#123;</div><div class="line">            return 204; // 等同于请求执行成功，但是没有数据，浏览器不用刷新页面.也不用导向新的页面</div><div class="line">        &#125;</div><div class="line">        add_header 'Access-Control-Allow-Origin' "$http_origin";</div><div class="line">        add_header 'Access-Control-Allow-Credentials' 'true';</div><div class="line">        add_header 'Access-Control-Allow-Methods' 'POST, GET, OPTIONS';</div><div class="line">       </div><div class="line">        proxy_pass http://weikemsg-web/weikemsg-web;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>再次跨域访问，结果如下：</p><p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fmomo4d3wbj31kw026wfq.jpg" alt="5EC9BD61-4FF4-4ED3-A69F-E73E0E9D0475"></p><p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fmomo1pawej31040cego7.jpg" alt="676169C7-A9CF-4737-8B1B-25546C423DDB"></p><p>跨域的问题已经解决，但是由于我的请求头中设置了<code>&#39;Content-Type&#39;:&#39;application/json&#39;</code>，需要服务端支持该类型</p><ol><li><strong>第三次尝试解决: 终极方案</strong></li></ol><p>重新配置<code>Nginx</code>：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /weikemsg-web &#123;</div><div class="line">        <span class="attribute">if</span> (<span class="variable">$request_method</span> = <span class="string">'OPTIONS'</span>) &#123;</div><div class="line">            <span class="attribute">return</span> <span class="number">204</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="attribute">add_header</span> <span class="string">'Access-Control-Allow-Origin'</span> <span class="string">"<span class="variable">$http_origin</span>"</span>;</div><div class="line">        <span class="attribute">add_header</span> <span class="string">'Access-Control-Allow-Credentials'</span> <span class="string">'true'</span>;</div><div class="line">        <span class="attribute">add_header</span> <span class="string">'Access-Control-Allow-Methods'</span> <span class="string">'POST, GET, OPTIONS'</span>;</div><div class="line">        <span class="attribute">add_header</span> <span class="string">'Access-Control-Allow-Headers'</span> <span class="string">'Content-Type'</span>;</div><div class="line">        <span class="attribute">proxy_pass</span> http://weikemsg-web/weikemsg-web;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><ul><li><code>Access-Control-Allow-Headers</code> ：指明了实际请求中允许携带的首部字段。</li></ul><p>结果如下：</p><p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fmomo20v2qj30t00fotay.jpg" alt="75C9B3DC-40DE-4F2D-BDE3-7E9B8E40E803"></p><p>到此，跨域问题终于解决了</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><code>Ajax</code>跨域可以用2种方式解决：<code>Nginx</code>跨域配置，<a href="https://dailc.github.io/2017/03/22/ajaxCrossDomainSolution.html" target="_blank" rel="external"><code>Java</code>服务端配置</a></p><h4 id="Nginx跨域配置-推荐"><a href="#Nginx跨域配置-推荐" class="headerlink" title="Nginx跨域配置(推荐)"></a><code>Nginx</code>跨域配置(推荐)</h4><ul><li><strong>简单跨域请求</strong></li></ul><p>如果需要跨域的服务接口提供简单的http请求，可以在<code>Nginx</code>中配置如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location ^~ /microlesson-web &#123;</div><div class="line">        add_header &apos;Access-Control-Allow-Origin&apos; &quot;*&quot;;</div><div class="line">        add_header &apos;Access-Control-Allow-Methods&apos; &apos;POST, GET, OPTIONS&apos;;</div><div class="line"></div><div class="line">        proxy_pass http://192.168.3.58:9280/microlesson-web;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p><strong>注意：如果<code>http</code>请求需要带上<code>Cookie</code>，必须设置<code>Access-Control-Allow-Credentials</code>为<code>true</code>，同时不能设置<code>Access-Control-Allow-Origin</code>为<code>*</code></strong></p><p>跨域发送<code>Cookie</code>还要求<code>Access-Control-Allow-Origin</code><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="external">不允许使用通配符</a>。 事实上不仅不允许通配符，而且<a href="https://www.w3.org/TR/2010/WD-cors-20100727/#resource-sharing-check0" target="_blank" rel="external">只能指定单一域名</a>：</p><blockquote><p>If the credentials flag is true and the response includes zero or more than one Access-Control-Allow-Credentials header values return fail and terminate this algorithm. –W3C Cross-Origin Resource Sharing</p></blockquote><p>修改如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">location ^~ /microlesson-web &#123;</div><div class="line">        add_header &apos;Access-Control-Allow-Origin&apos; &quot;$http_origin&quot;; //允许http访问源地址</div><div class="line">        add_header &apos;Access-Control-Allow-Credentials&apos; &apos;true&apos;;</div><div class="line">        add_header &apos;Access-Control-Allow-Methods&apos; &apos;POST, GET, OPTIONS&apos;;</div><div class="line">        add_header &apos;Access-Control-Allow-Headers&apos; &apos;Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Mx-ReqToken,X-Requested-With&apos;;</div><div class="line"></div><div class="line">        proxy_pass http://192.168.3.58:9280/microlesson-web;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><ul><li><strong>非简单跨域请求</strong></li></ul><p>项目中常见的非简单跨域请求一般是：<code>post</code>请求，以及<code>json</code>数据；<code>Nginx</code>配置如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">location ^~ /microlesson-web &#123;</div><div class="line">   if ($request_method = &apos;OPTIONS&apos;) &#123;</div><div class="line">       add_header Access-Control-Allow-Origin *; </div><div class="line">       add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS;</div><div class="line">       #其他头部信息配置，省略...</div><div class="line">       return 204;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">	add_header &apos;Access-Control-Allow-Origin&apos; &quot;$http_origin&quot;;</div><div class="line">	add_header &apos;Access-Control-Allow-Credentials&apos; &apos;true&apos;;</div><div class="line">	add_header &apos;Access-Control-Allow-Methods&apos; &apos;POST, GET, OPTIONS&apos;;</div><div class="line">	add_header &apos;Access-Control-Allow-Headers&apos; &apos;Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Mx-ReqToken,X-Requested-With&apos;;</div><div class="line"></div><div class="line">    proxy_pass http://192.168.3.58:9280/microlesson-web;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>关键的地方在于先判断请求类型如果是<code>OPTIONS</code>，设置<code>Allow</code>的响应头，重新处理这次请求。</p><ul><li><strong>过滤请求域名</strong></li></ul><p>如果需要指定一些域名跨域访问服务，可以如下配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">location ^~ /microlesson-web &#123;</div><div class="line">        set $cors &apos;&apos;;</div><div class="line">		if ($http_origin ~* &apos;http?://(localhost|www\.ximalaya\.com)&apos;) &#123;</div><div class="line">        	set $cors &apos;true&apos;;</div><div class="line">		&#125;</div><div class="line">		if ($cors = &apos;true&apos;) &#123;</div><div class="line">        	add_header &apos;Access-Control-Allow-Origin&apos; &quot;$http_origin&quot;;</div><div class="line">        	add_header &apos;Access-Control-Allow-Credentials&apos; &apos;true&apos;;</div><div class="line">        	add_header &apos;Access-Control-Allow-Methods&apos; &apos;GET, POST, OPTIONS&apos;;</div><div class="line">        	add_header &apos;Access-Control-Allow-Headers&apos; &apos;Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Mx-ReqToken,X-Requested-With&apos;;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">        proxy_pass http://192.168.3.58:9280/microlesson-web;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="external">HTTP访问控制(CORS)</a></p><p><a href="http://todoit.me/ajax-preflight/" target="_blank" rel="external">为什么我的跨域 AJAX 发了两个请求?</a></p><p><a href="http://kaifage.com/notes/181/configuration-cors-on-nginx.html" target="_blank" rel="external">Nginx配置支持CORS</a></p><p><a href="https://github.com/zhongxia245/blog/issues/33" target="_blank" rel="external">Nginx跨域配置</a></p><p><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="external">跨域资源共享 CORS 详解</a></p><p><a href="https://dailc.github.io/2017/03/22/ajaxCrossDomainSolution.html" target="_blank" rel="external">ajax跨域解决方案</a></p><p><a href="http://harttle.land/2016/12/28/cors-with-cookie.html" target="_blank" rel="external">CORS 跨域发送 Cookie</a></p></div><div></div><div></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/http/" rel="tag">#http</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/11/30/Spring-AOP源码分析/" rel="next" title="Spring AOP源码分析"><i class="fa fa-chevron-left"></i> Spring AOP源码分析</a></div><div class="post-nav-prev post-nav-item"> <a href="/2017/12/27/EventBus/" rel="prev" title="EventBus">EventBus<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"><div class="jiathis_style"><a class="jiathis_button_tsina"></a><a class="jiathis_button_tqq"></a><a class="jiathis_button_weixin"></a><a class="jiathis_button_cqq"></a><a class="jiathis_button_douban"></a><a class="jiathis_button_renren"></a><a class="jiathis_button_qzone"></a><a class="jiathis_button_kaixin001"></a><a class="jiathis_button_copy"></a><a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script></div></div></div><p>热评文章</p><div class="ds-top-threads" data-range="weekly" data-num-items="4"></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="David"><p class="site-author-name" itemprop="name">David</p><p class="site-description motion-element" itemprop="description">Develop Notes</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">143</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags"><span class="site-state-item-count">37</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/zsr" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="http://weibo.com/u/2214956781" target="_blank" title="Weibo"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#跨域请求"><span class="nav-number">1.</span> <span class="nav-text">跨域请求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#简单请求"><span class="nav-number">1.1.</span> <span class="nav-text">简单请求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#非简单请求"><span class="nav-number">1.2.</span> <span class="nav-text">非简单请求</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#案例"><span class="nav-number">2.</span> <span class="nav-text">案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#背景说明"><span class="nav-number">2.1.</span> <span class="nav-text">背景说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#原因分析"><span class="nav-number">2.2.</span> <span class="nav-text">原因分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Nginx跨域配置-推荐"><span class="nav-number">3.1.</span> <span class="nav-text">Nginx跨域配置(推荐)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 - <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">David</span></div><div class="powered-by"> 由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="theme-info"> 主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var r=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),c=document.getElementById(t),s=document.getElementById(a);c.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length>1&&r.forEach(function(r){var c=!0,s=r.title.trim().toLowerCase(),n=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),i=r.url,o=-1,l=-1,p=-1;if(""!=s&&""!=n&&a.forEach(function(e,t){o=s.indexOf(e),l=n.indexOf(e),o<0&&l<0?c=!1:(l<0&&(l=0),0==t&&(p=l))}),c){e+=1,t+="<li><a href='"+i+"' class='search-result-title'>"+s+"</a>";var h=r.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;u<0&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),s.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script></body></html>